---
title: "PB-ROE：技术报告"
author:
- 蓝海
- 彭莉
documentclass: ctexart
output:
  rticles::fund_analysis:
    fig_caption: yes
    number_sections: yes
    toc: yes
  rmdformats::html_clean:
    highlight: kate
classoption: hyperref,
---

# PB和ROE

## PB的历史演进

PB勾结了股票市场上的两个信号：

* Price（价格）：这是个在市场上只要交易就变化着的快信号；
* Book (会计价值)：这是由会计师一定的会计准则为投资者记录的企业的账面价值，它是由企业的历史活动累积的、会计师周期性更新的慢信号。


```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.width=11,fig.cap='PB全市场历史统计'}
require(CAsset)
require(PerformanceAnalytics)
require(ggplot2)
init()
options(digits=2)
pdf.options(family = "GB1")
```

```{r, echo=FALSE,message=FALSE,warning=FALSE,cache=TRUE,fig.width=11,fig.cap='PB全市场历史统计'}
df=sqldf("select date_trunc('month',date),quantile(pb,0.05) as lower,quantile(pb,0.5) as median,quantile(pb,0.95) as upper from stock_finance_eastmoney where date>'2003-01-01' group by date_trunc('month',date)")
ggplot(df,aes(x=date_trunc,y=median))+geom_ribbon(aes(ymin=lower,ymax=upper),fill='grey70')+geom_line(col='red')
#df=sqldf("select date_trunc('month',date),pb from stock_finance where date>'2003-01-01' and pb is not null and pb<50")
#ggplot(df,aes(x=date_trunc,group=date_trunc,y=pb))+geom_boxplot()
```
阴影部分是同期市场上所有股票一月之间的PB值的5%至95%。而红色的线则代表这些PB数值的中位数。不难理解2007年和2015年市场泡沫期间，市场对于股票价格整个的高估，表现在PB值无论是低5%、高的95%还是中位数都整体上扬，伴随市场指数攀顶而到达顶点。有意思的是，2011年的PB估值水平又一次上升到一个几乎与2007年相似的高峰——尽管指数恢复的情况远未能达到前期泡沫时水平，但是PB值却十分接近泡沫时的高点。

以上现象可以用股票价格的恢复来解释吗？ 
我们看同一时期，沪深300的形态是：

```{r, echo=FALSE,message=FALSE,warning=FALSE,cache=TRUE,fig.width=11,fig.cap='沪深300历史趋势'}
hs300=sqldf("select date,close as price from index_ohlc_day where code='000300' and date>'2003-01-01' ")
ggplot(hs300,aes(x=date,y=price))+geom_line(col='blue')
```

显然，股票价格是能够部分解释PB的上扬，但是不能解释为什么会恢复的远远超出价格恢复的幅度，而几乎接近泡沫时期的高点。那么是由于账目价值恶化的结果吗？

同一时期，上市公司账面价值的变化是：

```{r, echo=FALSE,message=FALSE,warning=FALSE,cache=TRUE,fig.width=11,fig.cap='Bps全市场历史统计'}
df=sqldf("select date_trunc('month',date),quantile(bps,0.05) as lower,quantile(bps,0.5) as median,quantile(bps,0.95) as upper from stock_finance_eastmoney where date>'2003-01-01' group by date_trunc('month',date)")
ggplot(df,aes(x=date_trunc,y=median))+geom_ribbon(aes(ymin=lower,ymax=upper),fill='grey70')+geom_line(col='red')
```


公司账面价值的变化，依旧不能解释价格泡沫过后出现的PB“估值泡沫”的发生的原因\footnote{我们姑且把这一现象称之为“泡沫”。}。我们需要进一步的分析PB变化的原因。

```{r, echo=FALSE,message=FALSE,warning=FALSE,cache=TRUE,fig.width=11,fig.cap='PB全市场历史分布'}

df=sqldf("select date_trunc('quarter',date),pb from stock_finance_eastmoney where date>'2003-01-01' and pb is not null and pb<20")
ggplot(df,aes(x=date_trunc,group=date_trunc,y=pb))+geom_violin()

```

上图中，我们勾画了每个季度PB值分布的概率密度函数，从中可以看出从2007年以来PB的分布是纺锤形的。2010年市场PB值的分布与2007年市场泡沫时候是类似的，显示的是整体估值水平的上升，背后的动因是4万亿货币放水。之所以没有显示在沪深300的指数大幅度的上升（相比较于2007年）是由于当时主要要获益的股票不是沪深300针对的大盘股，而是一些中小盘、周期性、资源型股票。

```{r, echo=FALSE,message=FALSE,warning=FALSE,cache=TRUE,fig.width=11,fig.cap='各类股票收益历史趋势'}
library(reshape2)
df<-getPriceFromDB(stock_indexes[,1],from='2003-01-01',asset.names=stock_indexes[,2],join.method='left outer')
melted = melt(df,id.vars=c(1))
ggplot(melted,aes(x=date,y=value,colour=variable))+geom_line()+annotate('rect',xmin=as.Date('2009-01-01'),xmax=as.Date('2011-03-01'),ymin=0,ymax=15000,alpha=0.1,fill="blue")+annotate('text',x=as.Date('2010-01-01'),y=16000,size=4,label='4万亿货币泡沫')
```

从上图可以看到，中小板块在2011年左右超越2007年，创造了新高。这就帮助我们解释了2011年出现PB估值高点的原因。由此可见，PB值的中位数以及5%和95%的数值带确实能够揭示一些有趣的东西。而这些东西可能会被单一的指数所忽略。

那么市场上常常使用的均值系统用来表征PB信息是否也是有效的呢？市场经常讨论、关注的是PB值的资金加权算术平均，它代表的是市场整体上愿意为上市公司的账目资产支付的价格。考虑到中国股市的特殊性，流通股数的加权平均是首选、其次才是总股数的加权平均。毕竟非流通股，没有实际上的资金消耗需求，因而不能实在的反应市场所给出估值需要付出的代价。

```{r, echo=FALSE,message=FALSE,warning=FALSE,cache=TRUE,fig.width=11,fig.cap='流通权重PB均值全市场历史统计'}
df=sqldf("with x as (select date, sum(pb*\"OA\")/sum(\"OA\") as \"PB\" from stock_finance_weight_eastmoney where date>'2005-01-01' and pb is not null group by date having count(*)>100 order by date) select date_trunc('month',date) as date, avg(\"PB\") as \"PB\" from x group by date_trunc('month',date) ;")
ggplot(df,aes(x=date,y=PB))+geom_line(col='red')
#df=sqldf("select date_trunc('month',date),pb from stock_finance where date>'2003-01-01' and pb is not null and pb<50")
#ggplot(df,aes(x=date_trunc,group=date_trunc,y=pb))+geom_boxplot()
```
